#!/bin/sh
# HyperDAG pre-push hook - Comprehensive validation before sharing
# This hook runs before pushing to ensure shared code meets extreme quality standards

set -eu

# Import shared utilities
. "$(git rev-parse --show-toplevel)/scripts/shlib.sh"

echo "ðŸš€ Running pre-push validation..."

PROJECT_ROOT="$(git rev-parse --show-toplevel)"
pushd "$PROJECT_ROOT" >/dev/null

# Full static analysis
echo "ðŸ” Running comprehensive static analysis..."
if ! ./scripts/run-clang-tidy.sh; then
    echo "âŒ Static analysis failed"
    popd >/dev/null
    exit 1
fi

# Security scan
echo "ðŸ›¡ï¸ Running security audit..."
if ! ./scripts/security-audit.sh; then
    echo "âŒ Security audit failed"
    popd >/dev/null
    exit 1
fi

# Full test suite
if [ -d "build" ]; then
    echo "ðŸ§ª Running full test suite..."
    if ! make -C build test; then
        echo "âŒ Test suite failed"
        popd >/dev/null
        exit 1
    fi
    
    # Memory leak detection if ASan is available
    echo "ðŸ§ª Checking for memory leaks..."
    if [ -f "build/bin/hyperdag_tests" ]; then
        if ! ASAN_OPTIONS="abort_on_error=1:detect_leaks=1" build/bin/hyperdag_tests; then
            echo "âŒ Memory leak detected"
            popd >/dev/null
            exit 1
        fi
    fi
fi

# Performance regression check
if [ -d "benchmarks" ]; then
    echo "ðŸ“Š Running performance regression check..."
    if ! ./scripts/profile.sh --check-regression; then
        echo "âš ï¸ Performance regression detected (non-blocking)"
    fi
fi

popd >/dev/null
echo "âœ… All pre-push checks passed!"
echo "ðŸŽ‰ Code is ready for sharing - maintaining extreme quality standards!"