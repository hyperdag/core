#!/bin/sh
# Meta-Graph pre-commit hook - Extreme quality enforcement
# This hook runs before every commit to ensure code quality standards

set -eu

# Import shared utilities
PROJECT_ROOT="$(git rev-parse --show-toplevel)"
cd "$PROJECT_ROOT"
. ./scripts/mg.sh

echo "ğŸ”§ Running pre-commit quality checks..."
cd "$PROJECT_ROOT" >/dev/null

# Format all staged C/C++ files
echo "ğŸ“ Formatting staged files..."
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|h|cpp|hpp)$' | while read -r file; do
    if [ -f "$file" ]; then
        clang-format -i "$file"
        git add "$file"
        echo "  âœ“ Formatted: $file"
    fi
done

# Run shellcheck on staged shell scripts
echo "ğŸš Running shellcheck on staged shell scripts..."
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(sh)$|^scripts/' | while read -r file; do
    if [ -f "$file" ] && (head -1 "$file" | grep -q '^#!/.*sh' 2>/dev/null); then
        # Determine shell type from shebang
        if head -1 "$file" | grep -q bash; then
            shell_type="bash"
        else
            shell_type="sh"
        fi
        
        if ! shellcheck --shell="$shell_type" --exclude=SC1091,SC2034 "$file"; then
            echo "âŒ shellcheck failed for: $file"
            
            exit 1
        fi
        echo "  âœ“ Clean: $file"
    fi
done

# Run quick static analysis on staged files
echo "ğŸ” Running clang-tidy on staged files..."
git diff --cached --name-only --diff-filter=ACM | grep -E '\.(c|cpp)$' | while read -r file; do
    if [ -f "$file" ]; then
        if ! clang-tidy "$file" --quiet; then
            echo "âŒ clang-tidy failed for: $file"
            
            exit 1
        fi
        echo "  âœ“ Clean: $file"
    fi
done

# Check include guards
echo "ğŸ›¡ï¸ Checking include guards..."
if ! ./scripts/check-include-guards.sh; then
    echo "âŒ Include guard check failed"
    
    exit 1
fi

# Check version consistency
echo "ğŸ“‹ Checking version consistency..."
if ! ./scripts/check-version-consistency.sh; then
    echo "âŒ Version consistency check failed"
    
    exit 1
fi

# Run quick tests if available
if [ -d "build" ] && [ -f "build/Makefile" ]; then
    echo "ğŸ§ª Running quick tests..."
    if ! ./scripts/run-quick-tests.sh; then
        echo "âŒ Quick tests failed"
        
        exit 1
    fi
fi


echo "âœ… All pre-commit checks passed!"
echo "ğŸ’¡ Tip: Run 'make all' to ensure full build compatibility"
